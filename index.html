<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSVEP 点滅刺激</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      overflow: hidden;
    }
    .square {
      width: 120px;
      height: 120px;
      background-color: white;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: 4px solid transparent;
    }
    #left {
      left: calc(50% - 200px);
    }
    #right {
      left: calc(50% + 80px);
    }
  </style>
</head>
<body>
  <div id="left" class="square" style="display:none;"></div>
  <div id="right" class="square" style="display:none;"></div>

  <script>
    const timeline = [
      { type: "rest", duration: 10 },
      { type: "stim", target: "left", freq: 5, duration: 5 },
      { type: "rest", duration: 3 },
      { type: "stim", target: "right", freq: 12, duration: 5 },
      { type: "rest", duration: 3 },
      { type: "stim", target: "left", freq: 6, duration: 5 },
      { type: "rest", duration: 3 },
      { type: "stim", target: "right", freq: 10, duration: 5 },
    ];

    const squares = {
      left: document.getElementById("left"),
      right: document.getElementById("right")
    };

    let currentPhase = 0;
    let currentStart = null;
    let stimFreq = null;
    let stimTarget = null;
    let animationId = null;

    function animate(timestamp) {
      if (!currentStart) currentStart = timestamp;
      const elapsed = (timestamp - currentStart) / 1000;
      const phase = Math.sin(2 * Math.PI * stimFreq * elapsed);
      if (stimTarget) {
        const el = squares[stimTarget];
        el.style.backgroundColor = phase > 0 ? "white" : "black";
      }
      animationId = requestAnimationFrame(animate);
    }

    async function runExperiment() {
      for (const block of timeline) {
        if (block.type === "rest") {
          cancelAnimationFrame(animationId);
          Object.values(squares).forEach(el => el.style.display = "none");
          document.body.style.backgroundColor = "black";
          await new Promise(r => setTimeout(r, block.duration * 1000));
        } else if (block.type === "stim") {
          stimFreq = block.freq;
          stimTarget = block.target;
          const el = squares[stimTarget];
          el.style.display = "block";
          document.body.style.backgroundColor = "black";
          currentStart = null;
          requestAnimationFrame(animate);
          await new Promise(r => setTimeout(r, block.duration * 1000));
          cancelAnimationFrame(animationId);
          el.style.display = "none";
        }
      }
      // 終了時
      document.body.style.backgroundColor = "black";
      alert("実験が終了しました");
    }

    runExperiment();
  </script>
</body>
</html>
